# Unified Gates Contracts
# This documents the stable interfaces for the gates.yaml configuration format
# Breaking changes require migration path and major version bump

config_version: 1

gates_yaml:
  description: "Unified configuration for all gate types"
  location: "product repo root"

  schema:
    version:
      type: integer
      required: true
      description: "Configuration schema version. Currently: 1"
      stability: "Field is frozen. Value will increment on breaking changes."

    charter:
      type: object
      description: "Charter gate behavior configuration"
      properties:
        enforce_reviews:
          type: boolean
          default: true
          description: "Block work if review date is past due. If false, warns instead."

    engineering:
      type: object
      description: "Engineering gate behavior configuration"
      properties:
        stack:
          type: enum
          values: [auto, node-typescript, node-javascript, python, go, rust, unknown]
          default: "auto"
          description: "Stack detection override. Auto-detected from project files if not specified."

        checks:
          type: object
          properties:
            lint:
              type: boolean
              default: true
            types:
              type: boolean
              default: true
            tests:
              type: boolean
              default: true
            format:
              type: boolean
              default: true

        coverage_threshold:
          type: integer
          default: 0
          description: "Minimum test coverage percentage. 0 = no enforcement."

        lint_config:
          type: string
          description: "Path to custom lint config file"

        test_command:
          type: string
          description: "Custom test command (overrides auto-detection)"

        custom_checks:
          type: array
          description: "Project-specific checks to run alongside built-in gates"
          items:
            type: object
            properties:
              name:
                type: string
                required: true
                description: "Identifier for the check (used in output)"
              command:
                type: string
                required: true
                description: "Shell command to execute"
              phase:
                type: enum
                values: [pre-commit, pre-push]
                required: true
                description: "When to run: pre-commit (fast) or pre-push (thorough)"
              blocking:
                type: boolean
                default: true
                description: "If true, failure blocks the operation. If false, warns only."

custom_check_contract:
  description: "Interface for custom check commands"

  exit_codes:
    0: "Check passed"
    1: "Check failed"
    2: "Check skipped (not applicable)"

  output:
    format: "Free-form text to stdout"
    notes:
      - "Output is displayed to user on failure"
      - "Keep output concise and actionable"

  examples:
    simple_script: |
      #!/bin/bash
      # Example: check-bundle-size.sh
      LIMIT=500  # KB

      SIZE=$(du -sk dist/ | cut -f1)
      if [ "$SIZE" -gt "$LIMIT" ]; then
          echo "Bundle too large: ${SIZE}KB (limit: ${LIMIT}KB)"
          exit 1
      fi
      echo "Bundle size OK: ${SIZE}KB"
      exit 0

    npm_command: "npm audit --audit-level=high"

  best_practices:
    - "Exit quickly on success (0)"
    - "Provide actionable error messages on failure (1)"
    - "Use exit 2 to skip gracefully when check doesn't apply"
    - "Avoid interactive prompts"

  stability:
    - "Version field is required and frozen"
    - "New fields are always optional with sensible defaults"
    - "Existing field types and defaults cannot change without major version"
    - "Removal of fields requires deprecation period"

  backward_compatibility:
    - "Scripts check for gates.yaml first, fall back to engineering.yaml"
    - "engineering.yaml (legacy) continues to work indefinitely"
    - "Charter content remains in charter/charter.yaml (unchanged)"

gates_local:
  description: "Local configuration overrides (not committed)"
  file: ".gates.local"
  location: "product repo root (gitignored)"

  behavior:
    - "Same schema as gates.yaml"
    - "Values in .gates.local override gates.yaml on a per-key basis"
    - "Deep merge: only specified keys are overridden, others inherit from gates.yaml"
    - "Version field is optional in .gates.local"

  resolution_order:
    1: ".gates.local (if exists)"
    2: "gates.yaml (if exists)"
    3: "engineering.yaml (legacy, if exists)"
    4: "built-in defaults"

  use_cases:
    - "Developer temporarily disabling checks during experimentation"
    - "Local tooling differences (different test command)"
    - "Avoiding 'git stash config' workflow"

  example: |
    # .gates.local - Developer's local overrides
    # This file is gitignored and not shared with team

    engineering:
      checks:
        types: false  # My IDE handles type checking
      test_command: npm run test:fast

  stability:
    - "Same schema stability as gates.yaml"
    - "Override behavior is frozen"

version_migration:
  description: "How to handle version changes"

  current_version: 1

  rules:
    - "Missing version field: warn, assume version 1"
    - "Version > supported: warn, attempt to run (forward compatible)"
    - "Version < current: run normally (backward compatible)"

  breaking_changes_require:
    - "Major version bump"
    - "Migration documentation"
    - "Deprecation warnings in previous release"
